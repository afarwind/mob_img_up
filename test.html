<html>
    <head>
        <meta charset="utf-8" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black" />
        <meta name="format-detection" content="telephone=no" />
        <meta http-equiv="pragma" content="no-cache" />
        <meta http-equiv="expires" content="-1" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">

        <meta name="keywords" content="" />
        <meta name="description" content=" " />
        <title> local resize img test </title>
    </head>
    <body>


    <form action="save.php" method="post" enctype="multipart/form-data" >
        <div class="up_img">
            <input type="file" class="upload_file" id="upload_file_0" name="upload_file[]" />
        </div>

        <canvas id="myCanvas"></canvas>
    </form>



    <script src="zepto.js" type="text/javascript"></script>
    <script type="text/javascript">
		// 参数，最大高度
		var MAX_HEIGHT = 100;

		$.fn.localResizeIMG = function(obj) {
            this.on('change', function () {
	            var file = this.files[0];
	            var URL = URL || webkitURL;
	            var blob = URL.createObjectURL(file);

	            // 执行前函数
	            if($.isFunction(obj.before)) { obj.before(this, blob, file) };
	            loadImage(file);
	            //this.value = '';   // 清空临时数据
	        });



            

			// 渲染
			function render(src){
				// 创建一个 Image 对象
				var image = new Image();
				// 设置src属性，浏览器会自动加载。
				image.src = src;
				// 绑定 load 事件处理器，加载完成后执行
				image.onload = function(){
					
					// 如果高度超标
					if(image.height > MAX_HEIGHT) {
						// 宽度等比例缩放 *=
						image.width *= MAX_HEIGHT / image.height;
						image.height = MAX_HEIGHT;
					}


					// 获取 canvas DOM 对象
					var canvas = document.getElementById("myCanvas");
					//var canvas = document.createElement('canvas');
					// 获取 canvas的 2d 环境对象,
					// 可以理解Context是管理员，canvas是房子
					var ctx = canvas.getContext("2d");
					// canvas清屏
					ctx.clearRect(0, 0, canvas.width, canvas.height);
					// 重置canvas宽高
					canvas.width = image.width;
					canvas.height = image.height;
					// 将图像绘制到canvas上
					ctx.drawImage(image, 0, 0, image.width, image.height);
					// !!! 注意，image 没有加入到 dom之中

					//生成base64
					var base64 = canvas.toDataURL("image/jpeg", obj.quality || 0.8);
                    var result = {
                        base64: base64,
                        clearBase64: base64.substr( base64.indexOf(',') + 1 )
                    };
                    obj.success(result);
				};
			};



			// 加载 图像文件(url路径)
			function loadImage(src){
				// 过滤掉 非 image 类型的文件
				if(!src.type.match(/image.*/)){
					if(window.console){
						console.log("选择的文件类型不是图片: ", src.type); 
					} else {
						window.confirm("只能选择图片文件");
				}
				return;
			}
			//render(blob);
			// 创建 FileReader 对象 并调用 render 函数来完成渲染.
			var reader = new FileReader();
				// 绑定load事件自动回调函数
				reader.onload = function(e){
				// 调用前面的 render 函数
				render(e.target.result);
			};
				// 读取文件内容
				reader.readAsDataURL(src);
			};
        };


        $(function(){

        	$("#upload_file_0").localResizeIMG({
        		width: 100,
		       	quality: 0.1,
		        //before: function (that, blob) {},
		        success: function (result) {
		            // var img = new Image();
		            // img.src = result.base64;
		            // $('body').append(img);
		            // console.log(result);
		        }
        		
        	});
        })

    </script>
    </body>
</html>